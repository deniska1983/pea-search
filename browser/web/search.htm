<html>
<head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>文件搜索</title>
    <link rel="stylesheet" href="./main.css" type="text/css" />
    <link rel="stylesheet" href="./thumbnail.css" type="text/css" />
    <link rel="shortcut icon" href="./favicon.ico" type="image/ico" />
    <link rel="icon" href="./favicon.ico" type="image/ico" />
	<script type="text/javascript" src="jquery-1.6.min.js"></script>
	<script type="text/javascript" src="jquery-jtemplates.js"></script>
    <script type="text/javascript" src="jquery.contextmenu.r2.js"></script>
    <script type="text/javascript" src="jquery-ui-1.8.12.custom.min.js"></script>
	<link type="text/css" href="jquery-ui-1.8.12.custom.css" rel="stylesheet" />	
    <script type="text/javascript" src="message.js"></script>
    <script type="text/javascript" src="context.js"></script>
    <script type="text/javascript" src="scroll.js"></script>
    <script type="text/javascript" src="disk.js"></script>
<script type="text/javascript" src="subnav.js"></script>
</head>
<body>
<div class="topbar">
  <div class="iconbox">
    <div class="leftbar">
      <object id="plugin0" type="application/x-plugingigaso" width="0" height="0">
      </object>
      <ul>
        <li><a onClick="return_history();" title="主页"><img src="images/icon-01.png" width="21" height="19"></a></li>
        <li><a onClick="refresh();"  title="刷新"><img src="images/icon-02.png" width="21" height="19"></a></li>
        <li><a onClick="cef.gigaso.zoom_in()" title="放大"><img src="images/icon-03.png" width="21" height="19"></a></li>
        <li><a onClick="cef.gigaso.zoom_out()" title="缩小"><img src="images/icon-04.png" width="21" height="19"></a></li>
        <li style="width:150px;">
          <input type="radio" name="case" id="case0">
          模糊查询
          <input type="radio" name="case" id="case1">
          精确查询</li>
      </ul>
    </div>

    <div class="rightbar">
      <ul>
        <li><a onClick="$('#search')[0].value='*'; searchf('*');orderby(2,true);" title="最大文件"><img src="images/icon-05.png" width="51" height="16"></a></li>
        <li><a onClick="online_db();" title="在线文件"><img src="images/icon-06.png" width="51" height="16"></a></li>
        <li class=""><a onClick="offline_db();" title="离线文件"><img src="images/icon-07.png" width="51" height="16"></a></li>
        <li style="width:34px;" onmouseover="layer_menu('m_sub1','1')" onmouseout="layer_menu('m_sub1','1')"><a href="#" title="设置"  _fcksavedurl="#"><img src="images/icon-08.png" width="34" height="16"></a>
          <div style="position:relative;">
            <div id=m_sub1 style="visibility:hidden; position:absolute; top:6px;left:-40px; z-index:99999;" >
              <ul>
                <li><img id="scanning" src="images/spinner.gif" style="visibility: hidden"/>
<a href="#" onclick="show_index_status();return false;">硬盘状态</a></li>
                <li><a href="#" onclick="show_hotkey();return false;">快捷键</a></li>
                <li><a href="#" onclick="show_export();return false;">导出查询结果</a></li>
                <li><a href="#">帮助</a></li>
                <li><a href="#" onClick="cef.gigaso.dev_tool();return false;">调试</a></li>
              </ul>
            </div>
          </div>
        </li>
      </ul>
    </div>
  </div>
  <center style="margin-top:10px;">
    <img src="images/logo.png" width="129" height="34">
    <input id="search" name="s" type="text" size="50" value="" title="查询条件" style="width:500px; height:34px; background:url(images/icon-search.png) no-repeat #FFF; padding-left:25px;"><img id="loading" src="images/spinner.gif" style="visibility: hidden"/><input type="text" id="dir">
  </center>
</div>
</div>
<div id="historys" style="align:center; "></div>
<textarea id="history_template" style="display:none"> 
		{#foreach $T as record}
        <div style="margin:0 auto; position:relative;">
		<div title="{$T.record.path}{$T.record.name}" class="history_file" style="cursor:hand; position:absolute; left:{$T.record.left}; top:{$T.record.top}; margin-top:-80px;">
			<div class="thumbnail-container">
				<div class="edit-mode-border">
					<div class="edit-bar">
					 <div class="pin"></div>
					 <div class="spacer"></div>
					 <div class="remove" title="不要显示" onclick="plugin.his_del({$T.record.id});$(this).parents('.history_file').hide();refresh();return false;"></div>
					</div>
					<span class="thumbnail-wrapper" style="background-image: url({$T.record.thumb})">
					 <span class="thumbnail"></span>
					</span>
					<input type="hidden" value="{$T.record.name}">
					<input type="hidden" value="{$T.record.path}">
				</div>
			</div>
			<div style="width:150px;text-align: center;word-break:break-all;">{$T.record.name2}</div>
		</div>
        </div>
		{#/for}
<div class="title-01">
<div class="title-01-left">常用文件</div>
<div class="title-01-right"><a onClick="history_switch();return false;">更多</a></div>
</div>
</textarea>





<div id="tabs" style="display:none">
	<ul id="main_nav_tab">
		<li>
			<a id="all-" href="#tab-1" onclick="file_type_search(0);return true;"><img src="icons/file.ico" class="icon"/>全部
			<br/><span id="all_file">0</span></a>
		</li>
		<li>
			<a id="dir-" href="#tab-1" onclick="file_type_search(2);return true;"><img src="icons/dir.ico" class="icon"/>文件夹
			<br/><span id="dir_file">0</span></a></li>
		<li>
			<a id="compress-" href="#tab-1" onclick="file_type_search(129);return true;"><img src="icons/zip.ico" class="icon"/>压缩包
			<br/><span id="compress_file">0</span></a></li>
		<li>
			<a id="program-" href="#tab-1" onclick="file_type_search(130);return true;"><img src="icons/exe.ico" class="icon"/>程序<img src="images/arrow-asc.png" valign="center" border="0"/>
			<br/><span id="program_file">0</span></a></li>
		<li>
			<a id="media-" href="#tab-1" onclick="file_type_search(131);return true;"><img src="icons/media.ico" class="icon"/>多媒体<img src="images/arrow-asc.png" valign="center" border="0"/>
			<br/><span id="media_file">0</span></a></li>
		<li>
			<a id="archive-" href="#tab-1" onclick="file_type_search(132);return true;"><img src="icons/txt.ico" class="icon"/>文档<img src="images/arrow-asc.png" valign="center" border="0"/>
			<br/><span id="archive_file">0</span></a></li>
		<li>
			<a id="other-" href="#tab-1" onclick="file_type_search(143);return true;"><img src="icons/unknown.ico" class="icon"/>其它
			<br/><span id="other_file">0</span></a>
		</li>
	</ul>
	<div id="tab-1">
		<div class="subnav" style="display:none; left:220px" id="program-div">
			<span class="subnav-span"><a onclick="file_type_search(17);return false;"><img src="icons/exe.ico" class="icon"/>程序(<span id="exe_file">0</span>)</a></span>
			<span class="subnav-span"><a onclick="file_type_search(18);return false;"><img src="icons/lnk.ico" class="icon"/>快捷方式(<span id="link_file">0</span>)</a></span>
			<span class="subnav-span"><a onclick="file_type_search(19);return false;"><img src="icons/script.ico" class="icon"/>脚本(<span id="script_file">0</span>)</a></span>
			<span class="subnav-span"><a onclick="file_type_search(20);return false;"><img src="icons/lib.ico" class="icon"/>库(<span id="lib_file">0</span>)</a></li>
		</div>
		<div class="subnav" style="display:none; left:310px" id="media-div">
			<span class="subnav-span"><a onclick="file_type_search(49);return false;"><img src="icons/music.ico" class="icon"/>音乐(<span id="music_file">0</span>)</a></span>
			<span class="subnav-span"><a onclick="file_type_search(50);return false;"><img src="icons/photo.ico" class="icon"/>图片(<span id="photo_file">0</span>)</a></span>
			<span class="subnav-span"><a onclick="file_type_search(51);return false;"><img src="icons/video.ico" class="icon"/>视频(<span id="video_file">0</span>)</a></span>
			<span class="subnav-span"><a onclick="file_type_search(52);return false;"><img src="icons/animation.ico" class="icon"/>动画(<span id="animation_file">0</span>)</a></span>
		</div>
		<div class="subnav" style="display:none; left:410px" id="archive-div">
			<span class="subnav-span"><a onclick="file_type_search(133);return false;"><img src="icons/word.ico" class="icon"/>office文档(<span id="office_file">0</span>)</a></span>
			<span class="subnav-span"><a onclick="file_type_search(134);return false;"><img src="icons/pdf.ico" class="icon"/>电子书(<span id="ebook_file">0</span>)</a></span>
			<span class="subnav-span"><a onclick="file_type_search(121);return false;"><img src="icons/htm.ico" class="icon"/>网页(<span id="htm_file">0</span>)</a></span>
			<span class="subnav-span"><a onclick="file_type_search(135);return false;"><img src="icons/source.ico" class="icon"/>其它文档(<span id="text_file">0</span>)</a></span>
		</div>
		<table id="maintable" width="100%" cellspacing="0">
			<thead>
				<tr unselectable="on" class="unselectable">
					<th style="width:42%" colid="0">文件名<span id="orderspan0"></span></th>
					<th style="width:42%" colid="1">文件夹<span id="orderspan1"></span></th>
					<th style="width:5%" align="right" colid="2">大小<span id="orderspan2"></span></th>
					<th style="width:11%" align="right" colid="3">修改日期<span id="orderspan3"></span></th>
				</tr>
			</thead>
			<tbody id="result1"> 
			</tbody> 
		</table>
	</div>
</div>


<textarea id="template" style="display:none"> 
		{#foreach $T as record}
        <tr unselectable="on" class="unselectable">
            <td colid="0">
				<img width="16" height="16" src="icons/{$T.record.type}.ico" />
				<input type="hidden" value="{$T.record.type}">
				<input type="hidden" value="{$T.record.name}">
				<input type="hidden" value="{$T.record.path}">
				<span title="{$T.record.name2}">{$T.record.name}</span>
            </td>
            <td colid="1">
				<span title="{$T.record.path2}">{$T.record.path}</span>
            </td>
            <td align="right" colid="2">
				<span>{$T.record.size}</span>
            </td>
            <td align="right" colid="3">
				<span>{$T.record.time}</span>
            </td>
        </tr>
		{#/for}
</textarea> 

<div id="message-area" style="opacity: 0; border-radius: 3px">no message.</div> 

<div id="myMenu1" style="display:none;">
  <ul>
    <li id="default"><img width="16" height="16" src="./images/win.png"> 打开</li>
    <li id="openas"><img width="16" height="16" src="./images/openas.ico"> 打开方式</li>
    <li id="explore"><img  width="16" height="16" src="./images/explore.ico"> 资源管理器</li>
    <li id="copypath"><img  width="16" height="16" src="./images/copypath.ico"> 复制全路径到剪贴板</li>
    <li id="copy"><img  width="16" height="16" src="./images/copy.ico"> 复制</li>
    <li id="cut"><img  width="16" height="16" src="./images/cut.ico"> 剪切</li>
    <li id="paste"><img  width="16" height="16" src="./images/paste.ico"> 粘贴</li>
    <li id="delete"><img  width="16" height="16" src="./images/delete.ico"> 删除</li>
    <li id="prop"><img  width="16" height="16" src="./images/prop.ico"> 属性</li>
  </ul>
</div>
<div id="myMenu2" style="display:none;">
  <ul>
    <li id="copypath"><img  width="16" height="16" src="./images/copypath.ico"> 复制全路径到剪贴板</li>
  </ul>
</div>

<div id="dialog-index-status" title="磁盘索引状态" style="display:none;">
<TABLE border="1">
<thead>
	<TR>
		<TD>盘符</TD>
		<TD>名称</TD>
		<TD>类型</TD>
		<TD>格式</TD>
		<TD>总大小</TD>
		<TD>可用空间</TD>
		<TD>索引状态</TD>
		<TD>重新索引</TD>
	</TR>
</thead>
<tbody id="index_status_result"> 
</tbody> 
</TABLE>
<textarea id="index_status_template" style="display:none"> 
		{#foreach $T as record}
        <tr unselectable="on" class="unselectable">
			<TR>
				<TD>{$T.record.panfu}:</TD>
				<TD><span title="{$T.record.serialNumber}">{$T.record.volumeName}</span></TD>
				<TD>{$T.record.typename}</TD>
				<TD>{$T.record.fsName}</TD>
				<TD>{$T.record.totalMB}</TD>
				<TD>{$T.record.totalFreeMB}</TD>
				<TD align="center"><img src="{$T.record.indexed}"></TD>
				<TD align="center"><img src="icons/disk.ico" title="重新扫描硬盘，建立索引" width="16" height="16" style="cursor:hand;{$T.record.display}" onclick="rescan(this.parentNode,{$T.record.id})"></TD>
			</TR>
        </tr>
		{#/for}
</textarea> 

<br>
离线磁盘的分区：
<TABLE border="1">
<thead>
	<TR>
		<TD>最后访问时间</TD>
		<TD>名称</TD>
		<TD>类型</TD>
		<TD>格式</TD>
		<TD>总大小</TD>
		<TD>可用空间</TD>
		<TD>状态</TD>
		<TD>删除索引</TD>
	</TR>
</thead>
<tbody id="offline-index_status_result"> 
</tbody> 
</TABLE>
<textarea id="offline_index_status_template" style="display:none"> 
		{#foreach $T as record}
        <tr unselectable="on" class="unselectable">
			<TR>
				<TD>{$T.record.time}</TD>
				<TD><span title="{$T.record.serialNumber}">{$T.record.volumeName}</span></TD>
				<TD>{$T.record.typename}</TD>
				<TD>{$T.record.fsName}</TD>
				<TD>{$T.record.totalMB}</TD>
				<TD>{$T.record.totalFreeMB}</TD>
				<TD>{$T.record.indexed}</TD>
				<TD align="center"><img src="images/delete.ico" title="删除此离线索引数据库" width="16" height="16" style="cursor:hand" onclick="del_offline_db(this.parentNode,{$T.record.id})"></TD>
			</TR>
        </tr>
		{#/for}
</textarea> 

</div>

<div id="dialog-set-hotkey" title="设置快捷键" style="display:none;">
	<select id="select-hotkey">
		<option value="0">PAUSE</option>
		<option value="1">ALT + PAUSE</option>
		<option value="2">F7</option>
		<option value="3">ALT + F7</option>
		<option value="4">F8</option>
		<option value="5">ALT + F8</option>
		<option value="6">F9</option>
		<option value="7">ALT + F9</option>
	</select>
	<input type="button" value="确定" onclick="set_hotkey();">
</div>

<div id="dialog-export" title="导出当前查询结果" style="display:none;">
请选择导出信息类型：
	<select id="select-export">
		<option value="0">文件名</option>
		<option value="1">全部信息（文件名/大小/日期）</option>
	</select>
<br>
导出文件名：
	<input type="text" id="export-filename" size="40" readonly="readonly">
<br>
	<input type="button" value="确定" onclick="do_export();">
</div>


<div id="dialog-upgrade" title="安装更新" style="display:none;">
更新说明：<br>
当前版本：<span id="old_version"></span><br>
更新版本：<span id="new_version"></span><br>

主要更新的功能：<br>
<p id="upgrade_desc"></p>
<br>
	<input type="button" value="立即安装" onclick="do_upgrade();">
	<input type="button" value="以后再说" onclick='$("#dialog-upgrade").dialog("close");'>

</div>


<script type="text/javascript">
	function trim(str, chars) {
		return ltrim(rtrim(str, chars), chars);
	}
	 
	function ltrim(str, chars) {
		chars = chars || "\\s";
		return str.replace(new RegExp("^[" + chars + "]+", "g"), "");
	}
	 
	function rtrim(str, chars) {
		chars = chars || "\\s";
		return str.replace(new RegExp("[" + chars + "]+$", "g"), "");
	}
	var plugin = document.getElementById('plugin0');
	function ieTrOver(){this.oldClassName=this.className;this.className="hovered"}
	function ieTrOut(){this.className=this.oldClassName}
	function table_over(){
			$("#maintable tr:nth-child(even)").addClass("d");
			if(window.ActiveXObject){
				$('tr').each(function(n){
					this.onmouseover = ieTrOver;
					this.onmouseout = ieTrOut;
					this.onselectstart = function(){return false};
				});
				$('td').each(function(n){
					this.onmouseover = ieTrOver;
					this.onmouseout = ieTrOut;
				});
			}
			if(!plugin.offline){
				$("#maintable tbody tr").contextMenu('myMenu1', context_menu_obj);
				$("#maintable tbody td[colid=0]").bind('dblclick',function(e){
					dblclick_file(e.currentTarget.parentNode);
				});
				$("#maintable tbody td[colid=1]").bind('dblclick',function(e){
					dblclick_path(e.currentTarget.parentNode);
				});
			}else{
				$("#maintable tbody tr").contextMenu('myMenu2', context_menu_obj);
			}
			highlight_timeout = setTimeout(highlight,1);
	  }
	  var icon_replace_index=0;
	  function icon_replace(){
			var finished = true;
			$("#maintable tbody tr").slice(icon_replace_index,icon_replace_index+10).each(function(i,o){
				get_file_path(o);
				var full_path = path+file;
				if(full_path.indexOf('%')!=-1) return;
				$(o).find("img")[0].src = "gigaso://icon/"+full_path;
				finished = false;
			});
			if(finished) return;
			icon_replace_index+=10;
			highlight_timeout = setTimeout(icon_replace,1);
	  }
	  function highlight(){
			$("#maintable tbody td[colid=0] span").each(function(i,o){
				var html = o.innerHTML;
				var fi = html.toLowerCase().indexOf($("#search").val().toLowerCase());
				if(fi==-1) return;
				o.innerHTML = html.substring(0, fi) + 
					"<span class='highlight-match'>"+html.substring(fi, fi+$("#search").val().length)+"</span>" + 
					html.substring(fi+$("#search").val().length, html.length);
			});
			icon_replace_index=0;
			if(in_exe && !plugin.offline) highlight_timeout = setTimeout(icon_replace,1);
			$("#loading").css("visibility","hidden");
	  }
</script>
<script type="text/javascript">
	var in_exe = false;
	var order_col;
	var order_desc;
	var cur_search;
	var files = [];
	var search_timeout;
	var highlight_timeout;
	var history_timeout;
	var stat_timeout;
	var pagerow = 100;
	var page_from = 0;

	function page(){
		var to = page_from + pagerow;
		if(changed()) return; //查询已过期
		if(page_from==0){
			$("#result1").processTemplate(files.slice(page_from,to));
		}else{
			if(files.length<=page_from) return;
			$("#result1").processTemplateAppend(files.slice(page_from,to));
		}
		page_from=to;
		if(files.length<=to){
			//show_info("分页完成");
		}
		table_over();
	}
	function file_name_trim(files){
		$(files).each( function sub(i,obj){
			if(obj.name.length>53){
				obj.name2 = obj.name;
				obj.name = obj.name2.substring(0, 25)+"..."+obj.name2.substring(obj.name2.length-25, obj.name2.length);
			}
			if(obj.path.length>52){
				obj.path2 = obj.path;
				obj.path = obj.path2.substring(0, 24)+"..."+obj.path2.substring(obj.path2.length-25, obj.path2.length);
			}
		});
	}
	function file_name_trim2(files){
		$(files).each( function sub(i,obj){
			if(obj.name.length>53){
				obj.name2 = obj.name.substring(0, 25)+"..."+obj.name.substring(obj.name.length-25, obj.name.length);
			}else{
				obj.name2 = obj.name;
			}
		});
	}
	function restart_when_error(){
			show_error("搜索服务失去响应。请稍后重试！");
			files = [];
			page_from = 0;
			page();
			plugin.start_server();
	}
	function searchf0(){
		stat_timeout = setTimeout(stat_search,10);
		$("#loading").css("visibility","visible");
		clearTimeout(highlight_timeout);
		var s = plugin.search(cur_search);
		if(changed()) return; //查询已过期
		try{
			files = eval(s);
		}catch(e){
			restart_when_error();
			$("#loading").css("visibility","hidden");
			return;
		}
		if(plugin.offline){
			var d_infos = get_loaded_offline_dbs();
			for(var f_index=0; f_index<files.length; f_index++)
				gen_offline_dir_name(files[f_index],d_infos);
		}
		file_name_trim(files);
		if(files.length==1000) files.push({type:"unknown", name:"......", path:"超过1000条的记录不显示"});
		page_from = 0;
		page();
	}
    function searchf(value){
		value = trim(value);
		if(value.length==0) return;
		$("#historys").fadeOut(300);
		$("#tabs").fadeIn(500);
		$("#loading").css("visibility","visible");
		cur_search = value;
		clearTimeout(search_timeout);
		clearTimeout(stat_timeout);
		clearTimeout(highlight_timeout);
		$("#tabs ul span").html("0");
		$("#tab-1 span span").html("0");
		if(value==""){
			$("#result1").html("");
			$("#loading").css("visibility","hidden");
			return;
		}
		if(value.length<=4){
			search_timeout = setTimeout(searchf0,300);
		}else{
			search_timeout = setTimeout(searchf0,150);
		}        
	}
	function changed(){
		value = $("#search").val();
		value = trim(value);
		return value != cur_search;
	}
	function search_if_change(){
		if(changed()) searchf(value);
	}
	function orderby(col,desc){
		$("#loading").css("visibility","visible");
		order_col = col;
		order_desc = desc;
		plugin.order = col*2+desc+1;
		if(!desc){
			$("#maintable th span").html("");
			$("#orderspan"+col).html("<img src='images/s_asc.png' />");
		}else{
			$("#maintable th span").html("");
			$("#orderspan"+col).html("<img src='images/s_desc.png' />");
		}
		if(files.length>0){
			clearTimeout(search_timeout);
			search_timeout = setTimeout(searchf0,5);
		}
	}
	function file_type_search(ft){
		$("#loading").css("visibility","visible");
		plugin.file_type=ft;
		if($("#search").val()=="") return;
		clearTimeout(search_timeout);
		search_timeout = setTimeout(searchf0,5);
	}
	function stat_num_set(stats){
		$("#all_file").html(stats.all);
		$("#dir_file").html(stats.dir);
		$("#compress_file").html(stats.compress);
		$("#program_file").html(stats.program);
		$("#media_file").html(stats.media);
		$("#archive_file").html(stats.archive);
		$("#other_file").html(stats.other);
		$("#exe_file").html(stats.exe);
		$("#link_file").html(stats.link);
		$("#script_file").html(stats.script);
		$("#lib_file").html(stats.lib);
		$("#music_file").html(stats.music);
		$("#photo_file").html(stats.photo);
		$("#video_file").html(stats.video);
		$("#animation_file").html(stats.animation);
		$("#office_file").html(stats.office);
		$("#ebook_file").html(stats.ebook);
		$("#htm_file").html(stats.htm);
		$("#text_file").html(stats.text);
	}
	function stat_search(){
		if(changed()) return; //查询已过期
		if(cur_search=="") return;
		var s = plugin.stat(cur_search);
		try{
			var stats = eval("("+s+")");
			stat_num_set(stats);
		}catch(e){
			restart_when_error();
		}
	}
	function history_parse(start_index){
		if(arguments.length==0) start_index=0;
		var hs = plugin.history().replace(/\\/g,"\\\\");
		hs = eval(hs);
		for( var i=0;i<hs.length;i++){
			var fname = hs[i].name;
			if(fname.charAt(fname.length-1)=='\\') fname = fname.substr(0,fname.length-1);
			function calc_top(x){if(x>=15) x-=15;if(x>=10) return 460;if(x>=5) return 290;return 120}
			function calc_left(x){if(x>=15) x-=15;return 10+200*(x%5)}
			hs[i].id = i;
			hs[i].left = calc_left(i);
			hs[i].top = calc_top(i);
			hs[i].path = fname.substring(0, fname.lastIndexOf("\\")+1);
			hs[i].name = fname.substring(fname.lastIndexOf("\\")+1,fname.length);
			if(hs[i].name==""){
				hs[i].thumb = "";
			}else{
				if(in_exe){
					hs[i].thumb = "gigaso://thumb/"+hs[i].path+hs[i].name;
					hs[i].thumb = hs[i].thumb.replace(/\\/g,"\\\\");
					hs[i].thumb = hs[i].thumb.replace(/ /g,"%20");
				}else{
					hs[i].thumb = hs[i].id+".jpg";
				}
			}
		}
		file_name_trim2(hs);
		$("#historys").setTemplateElement("history_template");
		hs0 = hs.slice(start_index,start_index+15);
		$("#historys").processTemplate(hs0);
		$(".thumbnail-wrapper").bind('click',function(e){
			dblclick_file(e.currentTarget.parentNode);
		});
		$(".thumbnail-wrapper").contextMenu('myMenu1',context_menu_obj);
		for( var i=0;i<hs0.length;i++){
			var p = $(".edit-bar .pin")[i];
			p.idx = i;
			if(hs[i].pin==1){
				$(p).addClass("pinned");
				p.title = "取消固定";
				$(p).bind('click',function(e){
					plugin.his_unpin(e.currentTarget.idx);
					$(e.currentTarget).attr("title",'固定在此显示');
					$(e.currentTarget).removeClass("pinned");
				});
			}else{
				p.title = "固定在此显示";
				$(p).bind('click',function(e){
					plugin.his_pin(e.currentTarget.idx);
					$(e.currentTarget).attr("title",'取消固定');
					$(e.currentTarget).addClass("pinned");
				});
			}
		}
		$("#loading").css("visibility","hidden");
		//$("div.pin first").addClass("pinned")
	}
	function history_thumb(){
		if(!in_exe) plugin.his_thumb();
		history_parse_timeout = setTimeout(history_parse,1);
	}
	function load_history(){
		$("#loading").css("visibility","visible");
		history_thumb_timeout = setTimeout(history_thumb,1);
	}
	function return_history(){
		$("#loading").css("visibility","visible");
		$("#tabs").fadeOut(300);
		$("#historys").show();
		load_history();
		$("#search").val("");
		$("#search").focus();
	}
	var his_start=true;
	function history_switch(){
		if(his_start){
			history_parse(15);
			his_start = false;
		}else{
			history_parse(0);
			his_start = true;
		}
	}
	function refresh(){
		if($("#search").val()!="") searchf($("#search").val()); 
		else load_history();
	}
	function init_dir(ss){ //Called from exe
		if(ss.charAt(0)=='"'){
			var findex = ss.indexOf('"',1);
			if(findex==-1) return;
			ss = ss.substring(findex+1, ss.length);
		}else{
			var findex = ss.indexOf(' ',1);
			if(findex==-1) return;
			ss = ss.substring(findex+1, ss.length);
		}
		ss = trim(ss);
		if(ss.charAt(0)=='"'){
			var findex = ss.indexOf('"',1);
			if(findex==-1) return;
			ss = ss.substring(1, findex);
		}else{
			var findex = ss.indexOf(' ',1);
			if(findex==-1) return;
			ss = ss.substring(1, findex);
		}
		if(ss.length<=1) return;
		clearTimeout(history_timeout);
		plugin.dire = ss;
		$("#dir")[0].value = ss;
		$("#search")[0].value = "*";
		$("#search")[0].select();
		searchf("*");
	}
	function init_event(){
		$("#dir").bind('keyup',function(event,t){
			plugin.dire = $("#dir")[0].value;
		});
		$("#case0").bind('click',function(event,t){
			plugin.caze = false;
			searchf($("#search").val());
		});
		$("#case1").bind('click',function(event,t){
			plugin.caze = true;
			searchf($("#search").val());
		});
		$("#result1").setTemplateElement("template");
		$(document).bind("contextmenu", function(e){
			return false;
		});
		$("#maintable th").bind('click',function(event,t){
			var index = this.getAttribute("colid");
			if(index==order_col){
				orderby(index,!order_desc);
			}else{
				orderby(index,1);
			}
		});
		orderby(0,0);
		$(window).bind('scroll',function(e){
			if(files.length > page_from){
				//show_info(page_from);
				if(reachBottom()) page();
			}
		});
		$("#tabs ul li a").bind('click',function(e){
			$(".subnav").hide();
			$("#"+e.target.id+"div").show();
		});
		$('#tabs').tabs();
		scan_img();
	}
	function regplugin(){
			cef.gigaso.reg_plugin();
			show_info("插件初始化成功！请重启本软件。");
	}
	$(function() {
		try{
			if(!plugin.search){
				regplugin();
			}
		}catch(e){
				regplugin();
		}
		if(plugin.caze){
			$("#case1").click();
		}else{
			$("#case0").click();
		}
		$("#search").focus();
		$("#search").bind('keyup',search_if_change);
		var update_status = cef.gigaso.check_update();
		if(update_status==0){
			upgrade_req();
		}else if(update_status==1){
			show_upgrade();
		}
		setTimeout(init_event,1);
		history_timeout = setTimeout(load_history,50);
	});
</script>
</body>

</html>
