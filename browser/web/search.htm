<html>
<head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>文件搜索</title>
    <link rel="stylesheet" href="./main.css" type="text/css" />
    <link rel="stylesheet" href="./thumbnail.css" type="text/css" />
    <link rel="shortcut icon" href="./favicon.ico" type="image/ico" />
    <link rel="icon" href="./favicon.ico" type="image/ico" />
	<script type="text/javascript" src="jquery-1.6.min.js"></script>
	<script type="text/javascript" src="jquery-jtemplates.js"></script>
    <script type="text/javascript" src="jquery.contextmenu.r2.js"></script>
    <script type="text/javascript" src="jquery.corner.js"></script>
    <script type="text/javascript" src="jquery-ui-1.8.12.custom.min.js"></script>
	<link type="text/css" href="jquery-ui-1.8.12.custom.css" rel="stylesheet" />	
    <script type="text/javascript" src="message.js"></script>
    <script type="text/javascript" src="context.js"></script>
    <script type="text/javascript" src="scroll.js"></script>
</head>

<body>
<object id="plugin0" type="application/x-plugingigaso" width="10" height="10">
</object>
<input type="button" value="刷新" onclick="refresh();">
<input type="radio" name="case" id="case0">模糊查询（模糊拼音、不区分英文大小写）
<input type="radio" name="case" id="case1">精确模糊（非模糊拼音、区分英文大小写）

<center style="margin:10px;">
搜索：<img id="loading" src="images/spinner.gif" style="visibility: hidden"/>
<input id="dir" name="dir" type="text" size="20" value="" title="目录"><input id="search" name="s" type="text" size="35" value="" title="查询条件"><img id="search_img" src="images/find.ico"/>

</center>

<div id="historys">
</div>
<textarea id="history_template" style="display:none"> 
		{#foreach $T as record}
		<div title="{$T.record.path}{$T.record.name}" class="history_file" style="cursor:hand; position:absolute; left:{$T.record.left}; top:{$T.record.top}">
			<div class="thumbnail-container">
				<div class="edit-mode-border">
					<div class="edit-bar">
					 <div class="pin" title="固定在此显示"></div>
					 <div class="spacer"></div>
					 <div class="remove" title="不要显示"></div>
					</div>
					<span class="thumbnail-wrapper" style="background-image: url({$T.record.id}.jpg); ">
					 <span class="thumbnail"></span>
					</span>
					<input type="hidden" value="{$T.record.name}">
					<input type="hidden" value="{$T.record.path}">
				</div>
			</div>
			<div style="width:150px;text-align: center;word-break:break-all;font-size:12pt">{$T.record.name2}</div>
		</div>
		{#/for}
</textarea> 

<div id="tabs" style="display:none">
	<ul>
		<li>
			<a id="all-" href="#tab-1" onclick="file_type_search(0);return true;"><img src="icons/file.ico" class="icon"/>全部
			<br/><span id="all_file">0</span></a>
		</li>
		<li>
			<a id="dir-" href="#tab-1" onclick="file_type_search(2);return true;"><img src="icons/dir.ico" class="icon"/>文件夹
			<br/><span id="dir_file">0</span></a></li>
		<li>
			<a id="compress-" href="#tab-1" onclick="file_type_search(129);return true;"><img src="icons/zip.ico" class="icon"/>压缩包
			<br/><span id="compress_file">0</span></a></li>
		<li>
			<a id="program-" href="#tab-1" onclick="file_type_search(130);return true;"><img src="icons/exe.ico" class="icon"/>程序<img src="images/arrow-asc.png" valign="center" border="0"/>
			<br/><span id="program_file">0</span></a></li>
		<li>
			<a id="media-" href="#tab-1" onclick="file_type_search(131);return true;"><img src="icons/media.ico" class="icon"/>多媒体<img src="images/arrow-asc.png" valign="center" border="0"/>
			<br/><span id="media_file">0</span></a></li>
		<li>
			<a id="archive-" href="#tab-1" onclick="file_type_search(132);return true;"><img src="icons/txt.ico" class="icon"/>文档<img src="images/arrow-asc.png" valign="center" border="0"/>
			<br/><span id="archive_file">0</span></a></li>
		<li>
			<a id="other-" href="#tab-1" onclick="file_type_search(143);return true;"><img src="icons/unknown.ico" class="icon"/>其它
			<br/><span id="other_file">0</span></a>
		</li>
	</ul>
	<div id="tab-1">
		<div class="subnav" style="display:none; left:220px" id="program-div">
			<span class="subnav-span"><a onclick="file_type_search(17);return false;"><img src="icons/exe.ico" class="icon"/>程序(<span id="exe_file">0</span>)</a></span>
			<span class="subnav-span"><a onclick="file_type_search(18);return false;"><img src="icons/lnk.ico" class="icon"/>快捷方式(<span id="link_file">0</span>)</a></span>
			<span class="subnav-span"><a onclick="file_type_search(19);return false;"><img src="icons/script.ico" class="icon"/>脚本(<span id="script_file">0</span>)</a></span>
			<span class="subnav-span"><a onclick="file_type_search(20);return false;"><img src="icons/lib.ico" class="icon"/>库(<span id="lib_file">0</span>)</a></li>
		</div>
		<div class="subnav" style="display:none; left:310px" id="media-div">
			<span class="subnav-span"><a onclick="file_type_search(49);return false;"><img src="icons/music.ico" class="icon"/>音乐(<span id="music_file">0</span>)</a></span>
			<span class="subnav-span"><a onclick="file_type_search(50);return false;"><img src="icons/photo.ico" class="icon"/>图片(<span id="photo_file">0</span>)</a></span>
			<span class="subnav-span"><a onclick="file_type_search(51);return false;"><img src="icons/video.ico" class="icon"/>视频(<span id="video_file">0</span>)</a></span>
			<span class="subnav-span"><a onclick="file_type_search(52);return false;"><img src="icons/animation.ico" class="icon"/>动画(<span id="animation_file">0</span>)</a></span>
		</div>
		<div class="subnav" style="display:none; left:410px" id="archive-div">
			<span class="subnav-span"><a onclick="file_type_search(133);return false;"><img src="icons/word.ico" class="icon"/>office文档(<span id="office_file">0</span>)</a></span>
			<span class="subnav-span"><a onclick="file_type_search(134);return false;"><img src="icons/pdf.ico" class="icon"/>电子书(<span id="ebook_file">0</span>)</a></span>
			<span class="subnav-span"><a onclick="file_type_search(121);return false;"><img src="icons/htm.ico" class="icon"/>网页(<span id="htm_file">0</span>)</a></span>
			<span class="subnav-span"><a onclick="file_type_search(135);return false;"><img src="icons/source.ico" class="icon"/>其它文档(<span id="text_file">0</span>)</a></span>
		</div>
		<table id="maintable" width="100%" cellspacing="0">
			<thead>
				<tr unselectable="on" class="unselectable">
					<th style="width:42%" colid="0">文件名<span id="orderspan0"></span></th>
					<th style="width:42%" colid="1">文件夹<span id="orderspan1"></span></th>
					<th style="width:5%" align="right" colid="2">大小<span id="orderspan2"></span></th>
					<th style="width:11%" align="right" colid="3">修改日期<span id="orderspan3"></span></th>
				</tr>
			</thead>
			<tbody id="result1"> 
			</tbody> 
		</table>
	</div>
</div>


<textarea id="template" style="display:none"> 
		{#foreach $T as record}
        <tr unselectable="on" class="unselectable">
            <td colid="0">
				<img width="16" height="16" src="icons/{$T.record.type}.ico" />
				<input type="hidden" value="{$T.record.type}">
				<input type="hidden" value="{$T.record.name}">
				<input type="hidden" value="{$T.record.path}">
				<span title="{$T.record.name2}">{$T.record.name}</span>
            </td>
            <td colid="1">
				<span title="{$T.record.path2}">{$T.record.path}</span>
            </td>
            <td align="right" colid="2">
				<span>{$T.record.size}</span>
            </td>
            <td align="right" colid="3">
				<span>{$T.record.time}</span>
            </td>
        </tr>
		{#/for}
</textarea> 

<div id="message-area" style="opacity: 0;">no message.</div> 

<div id="myMenu1" style="display:none;">
  <ul style="font-size:10pt">
    <li id="default"><img width="16" height="16" src="./images/win.png"> 打开</li>
    <li id="openas"><img width="16" height="16" src="./images/openas.ico"> 打开方式</li>
    <li id="explore"><img  width="16" height="16" src="./images/explore.ico"> 资源管理器</li>
    <li id="copypath"><img  width="16" height="16" src="./images/copypath.ico"> 复制全路径到剪贴板</li>
    <li id="copy"><img  width="16" height="16" src="./images/copy.ico"> 复制</li>
    <li id="cut"><img  width="16" height="16" src="./images/cut.ico"> 剪切</li>
    <li id="paste"><img  width="16" height="16" src="./images/paste.ico"> 粘贴</li>
    <li id="delete"><img  width="16" height="16" src="./images/delete.ico"> 删除</li>
    <li id="prop"><img  width="16" height="16" src="./images/prop.ico"> 属性</li>
  </ul>
</div>

<script type="text/javascript">
	function trim(str, chars) {
		return ltrim(rtrim(str, chars), chars);
	}
	 
	function ltrim(str, chars) {
		chars = chars || "\\s";
		return str.replace(new RegExp("^[" + chars + "]+", "g"), "");
	}
	 
	function rtrim(str, chars) {
		chars = chars || "\\s";
		return str.replace(new RegExp("[" + chars + "]+$", "g"), "");
	}
	var plugin = document.getElementById('plugin0');
	function ieTrOver(){this.oldClassName=this.className;this.className="hovered"}
	function ieTrOut(){this.className=this.oldClassName}
	function table_over(){
			$("#maintable tr:nth-child(even)").addClass("d");
			if(window.ActiveXObject){
				$('tr').each(function(n){
					this.onmouseover = ieTrOver;
					this.onmouseout = ieTrOut;
					this.onselectstart = function(){return false};
				});
				$('td').each(function(n){
					this.onmouseover = ieTrOver;
					this.onmouseout = ieTrOut;
				});
			}
			$("#maintable tbody tr").contextMenu('myMenu1', context_menu_obj);
			$("#maintable tbody td[colid=0]").bind('dblclick',function(e){
				dblclick_file(e.currentTarget.parentNode);
			});
			$("#maintable tbody td[colid=1]").bind('dblclick',function(e){
				dblclick_path(e.currentTarget.parentNode);
			});
			highlight_timeout = setTimeout(highlight,0);
	  }
	  function highlight(){
			$("#maintable tbody td[colid=0] span").each(function(i,o){
				var html = o.innerHTML;
				var fi = html.toLowerCase().indexOf($("#search").val().toLowerCase());
				if(fi==-1) return;
				o.innerHTML = html.substring(0, fi) + 
					"<span class='highlight-match'>"+html.substring(fi, fi+$("#search").val().length)+"</span>" + 
					html.substring(fi+$("#search").val().length, html.length);
			});
			$("#loading").css("visibility","hidden");
	  }
</script>
<script type="text/javascript">
	var order_col;
	var order_desc;
	var cur_search;
	var files = [];
	var search_timeout;
	var highlight_timeout;
	var stat_timeout;
	var pagerow = 100;
	var page_from = 0;

	function page(){
		var to = page_from + pagerow;
		if($("#search").val()!=cur_search) return; //查询已过期
		if(page_from==0){
			$("#result1").processTemplate(files.slice(page_from,to));
		}else{
			if(files.length<=page_from) return;
			$("#result1").processTemplateAppend(files.slice(page_from,to));
		}
		page_from=to;
		if(files.length<=to){
			//show_info("分页完成");
		}
		table_over();
	}
	function file_name_trim(files){
		$(files).each( function sub(i,obj){
			if(obj.name.length>53){
				obj.name2 = obj.name;
				obj.name = obj.name2.substring(0, 25)+"..."+obj.name2.substring(obj.name2.length-25, obj.name2.length);
			}
			if(obj.path.length>52){
				obj.path2 = obj.path;
				obj.path = obj.path2.substring(0, 24)+"..."+obj.path2.substring(obj.path2.length-25, obj.path2.length);
			}
		});
	}
	function file_name_trim2(files){
		$(files).each( function sub(i,obj){
			if(obj.name.length>53){
				obj.name2 = obj.name.substring(0, 25)+"..."+obj.name.substring(obj.name.length-25, obj.name.length);
			}else{
				obj.name2 = obj.name;
			}
		});
	}
	function searchf0(){
		stat_timeout = setTimeout(stat_search,0);
		$("#loading").css("visibility","visible");
		clearTimeout(highlight_timeout);
		var s = plugin.search(cur_search);
		if($("#search").val()!=cur_search) return; //查询已过期
		try{
			files = eval(s);
		}catch(e){
			show_error("搜索服务失去响应！");
			$("#loading").css("visibility","hidden");
			return;
		}
		file_name_trim(files);
		if(files.length==1000) files.push({type:"unknown", name:"......", path:"超过1000条的记录不显示"});
		page_from = 0;
		page();
	}
    function searchf(value){
		value = trim(value);
		if(value.length==0) return;
		$("#historys").fadeOut();
		$("#tabs").show();
		$("#loading").css("visibility","visible");
		cur_search = value;
		clearTimeout(search_timeout);
		clearTimeout(stat_timeout);
		clearTimeout(highlight_timeout);
		$("#tabs ul span").html("0");
		$("#tab-1 span span").html("0");
		if(value==""){
			$("#result1").html("");
			$("#loading").css("visibility","hidden");
			return;
		}
		if(value.length<=4){
			search_timeout = setTimeout(searchf0,300);
		}else{
			search_timeout = setTimeout(searchf0,150);
		}        
	}
	function search_if_change(){
		value = $("#search").val();
		value = trim(value);
		if(value != cur_search) searchf(value);
	}
	function orderby(col,desc){
		order_col = col;
		order_desc = desc;
		plugin.order = col*2+desc+1;
		if(!desc){
			$("#maintable th span").html("");
			$("#orderspan"+col).html("<img src='images/s_asc.png' />");
		}else{
			$("#maintable th span").html("");
			$("#orderspan"+col).html("<img src='images/s_desc.png' />");
		}
		if(files.length>0){
			clearTimeout(search_timeout);
			search_timeout = setTimeout(searchf0,0);
		}
	}
	function file_type_search(ft){
		plugin.file_type=ft;
		if($("#search").val()=="") return;
		clearTimeout(search_timeout);
		search_timeout = setTimeout(searchf0,0);
	}
	function stat_num_set(stats){
		$("#all_file").html(stats.all);
		$("#dir_file").html(stats.dir);
		$("#compress_file").html(stats.compress);
		$("#program_file").html(stats.program);
		$("#media_file").html(stats.media);
		$("#archive_file").html(stats.archive);
		$("#other_file").html(stats.other);
		$("#exe_file").html(stats.exe);
		$("#link_file").html(stats.link);
		$("#script_file").html(stats.script);
		$("#lib_file").html(stats.lib);
		$("#music_file").html(stats.music);
		$("#photo_file").html(stats.photo);
		$("#video_file").html(stats.video);
		$("#animation_file").html(stats.animation);
		$("#office_file").html(stats.office);
		$("#ebook_file").html(stats.ebook);
		$("#htm_file").html(stats.htm);
		$("#text_file").html(stats.text);
	}
	function stat_search(){
		if($("#search").val()!=cur_search) return; //查询已过期
		if(cur_search=="") return;
		var s = plugin.stat(cur_search);
		try{
			var stats = eval("("+s+")");
			stat_num_set(stats);
		}catch(e){
			show_error("搜索服务失去响应！");
		}
	}
	function history_parse(){
		var hs = plugin.history().replace(/\\/g,"\\\\");
		hs = eval(hs);
		for( var i=0;i<hs.length;i++){
			if(hs[i].charAt(hs[i].length-1)=='\\') hs[i] = hs[i].substr(0,hs[i].length-1);
			tmp = {
				"id":i, 
				"left": 10+200*(i%5),
				"top" : i>=5? 350:150,
				"path": hs[i].substring(0, hs[i].lastIndexOf("\\")+1),
				"name": hs[i].substring(hs[i].lastIndexOf("\\")+1,hs[i].length)
			}
			hs[i] = tmp;
		}
		file_name_trim2(hs);
		$("#historys").setTemplateElement("history_template");
		$("#historys").processTemplate(hs.slice(0,10));
		$(".thumbnail-container").bind('click',function(e){
			dblclick_file(e.currentTarget);
		});
		$(".thumbnail-container").contextMenu('myMenu1',context_menu_obj);
	}
	function history_thumb(){ 	plugin.history_thumb(); }
	function load_history(){
		history_thumb_timeout = setTimeout(history_thumb,0);
		history_parse_timeout = setTimeout(history_parse,50);
	}
	function refresh(){
		if($("#search").val()!="") searchf($("#search").val()); 
		else load_history();
	}
	function init_dir(ss){ //Called from exe
		if(ss.charAt(0)=='"'){
			var findex = ss.indexOf('"',1);
			if(findex==-1) return;
			ss = ss.substring(findex+1, ss.length);
		}else{
			var findex = ss.indexOf(' ',1);
			if(findex==-1) return;
			ss = ss.substring(findex+1, ss.length);
		}
		ss = trim(ss);
		if(ss.charAt(0)=='"'){
			var findex = ss.indexOf('"',1);
			if(findex==-1) return;
			ss = ss.substring(1, findex);
		}else{
			var findex = ss.indexOf(' ',1);
			if(findex==-1) return;
			ss = ss.substring(1, findex);
		}
		if(ss.length<=1) return;
		clearTimeout(history_parse_timeout);
		plugin.dire = ss;
		$("#dir")[0].value = ss;
		$("#search")[0].value = "*";
		$("#search")[0].select();
		searchf("*");
	}
	$(function() {
		$("#dir")[0].value = plugin.dire;
		$("#dir").bind('keyup',function(event,t){
			plugin.dire = $("#dir")[0].value;
		});
		if(plugin.caze){
			$("#case1").click();
		}else{
			$("#case0").click();
		}
		$("#case0").bind('click',function(event,t){
			plugin.caze = false;
			searchf($("#search").val());
		});
		$("#case1").bind('click',function(event,t){
			plugin.caze = true;
			searchf($("#search").val());
		});
		$("#search").focus();
		$("#search").bind('keyup',search_if_change);
		$("#message-area").corner("bottom 3px");
		$("#result1").setTemplateElement("template");
		$(document).bind("contextmenu", function(e){
			//return false;
		});
		$("#maintable th").bind('click',function(event,t){
			var index = this.getAttribute("colid");
			if(index==order_col){
				orderby(index,!order_desc);
			}else{
				orderby(index,1);
			}
		});
		orderby(0,0);
		$(window).bind('scroll',function(e){
			if(files.length > page_from){
				show_info(page_from);
				if(reachBottom()) page();
			}
		});
		$('#tabs').tabs();
		$("#tabs ul li a").bind('click',function(e){
			$(".subnav").hide();
			$("#"+e.target.id+"div").show();
		});
		$( "#search_img").position({
			of: $( "#search" ),
			my: "right top",
			at: "right center",
			offset: "0px"
		});
		load_history();
	});

</script>

</body>

</html>
